PREVENCION DE EXPLOITS DE APLICACIONES
- Exploit: Metodo de programacion que se aprovecha de un error de sofware en particular.
- Puede protegerse contra vulnerabilidades de seguridad de las aplicaciones bloqueando las tecnicas de explotacion, no los ataques individuales.

	TECNICAS DE EXPLOTACION DE APLICACIONES
	- Aplicacion sin proteccion cortex XDR: Ejecucion de un documento PDF con codigo detras Por lo tanto, el usuario de este ejemplo abre el documento PDF y el documento se muestra como lo haría normalmente. Pero en el fondo se ponen en marcha las técnicas de explotación.
	![[Pasted image 20241204123625.png]]
	- Aplicacion con el agente cortex instalado: 
	 ![[Pasted image 20241204123805.png]]
	- Naturaleza encadenada de las tecnicas de explotacion: Basicamente si puede realizar algunas funciones pero al no completar toda la cadena no sirve ![[Pasted image 20241204124115.png]] 
	  EMP: Exploit protection module

	PREVENCION DE EXPLOITS DE APLICACIONES
	Tecnicas de explotacion de aplicaciones 
	- IE Zero Day CVE-2013-3893: Operation Deputy Dog, campaña de ataque utilizada para atacar a objetivoos japoneses, usaba una vulnerabilidad de internet explorer al acceder a un objeto en la memoria que ha sido eliminado, permitiendo ejecutar codigo en una maquina con solo visitar un web malicioso.
	- Adobe Reader CVE-2013-3346: Turla / Snake / Uroburos, campaña de ciberespionaje en curso. Se uso correos de spear phishing que utilizan una vulnerabilidad de adobe reader.
	- Adobe Flash CVE-2015-3010/0311: Dirigida a servicios financieros y de defensa de EU.
	El objetivo de cualquier exploit es llegar al kernel del sistema operativo para ejecutar operaciones de privilegios como llamadas al sistema o API.


TECNICAS DE EXPLOTACION Y MECANISMOS DE DEFENSA
	Componentes principales: HW, SO y Procesos.
1. Segmentación del espacio de direcciones virtuales de un proceso
	- Mensaje de texto: Instrucciones
	- Datos: Variables globales y estaticas
	- Monton (Heap): Asignaciones de memoria dinamica en tiempos de ejecucion.
	- Pila (Stack): Usada para almacenar los datos dependientes de la funcion.
	  ![[Pasted image 20250113124336.png|400]]

2. Metodo de ataque por desbordamiento de bufer: Basado en la falta de comprobacion de la longitud de los valores de entrada, si los datos criticos siguen inmediatamente a la ubicacion de la memoria el atacante puede afectar al flujo general del programa.
   
   El atacante agrega mas informacion de la esperada, en x86 se procesa el valor inmediatamente despues de que el bufer de entrada almacena con frecuencia la ubicacion de la siguiente instruccion de lenguaje maquina que va a ejecutar.
    ![[Pasted image 20241204130642.png]]
   Como PROTEGERSE? Con STACK CANARIES
   Asignamos un valor fijo en la memoria justo antes del puntero de ejecucion. Este valor se denomina canario de pila por llevar a un canario a minas para detectar modificaciones. Cualquier cambio en la pila mandara un exception.
   
   NOP SLED para mejorar ataques
   Los atacantes utilizan la técnica de trineo NOP para mejorar los ataques de desbordamiento de búfer
   Los ataques de desbordamiento de búfer se basan en la capacidad del atacante para colocar shellcode en ubicaciones de memoria conocidas, lo que puede ser difícil de lograr para el atacante. Los atacantes utilizan la técnica del "trineo NOP" para tratar de superar este obstáculo
   NOP es la representacion en lenguaje ensamblador de una instruccion en lenguaje maquina que no realiza ninguna operacion. Un trineo NOP es una secuencia de estos NOP
   
   
   Prevencion de ejecucuion de datos (DEP)
   Ayuda a protegerse contra vulnerabilidades de seguridad al impedir que la CPU ejecute codigo de las paginas de memoria a menos que esten marcadas como ejecutables.

3. Metodo de ataque de programacion orientada al retorno (ROP)
   Usado para un uso ilegitimo de funciones y rutinas de bibliotecas legitimas, no es codigo creado, es codigo reutilizado tomado y recibe un retorno a una llamada de funcion.
    ![[Pasted image 20241204132058.png]]
   
   Como PROTEGERSE?
   
   Aleatorizacion del diseño del espacio de direcciones (ASLR)
	- Componentes colocados aleatoriamente: Componentes de procesos: Las ubicaciones de pila, monton y las bibliotecas se colocan aleatoriamente en cada ejecucion. Esto basado en la suposicion de que los componentes estan en una ubicacion conocida, fallara.
	  El espacio de direcciones virtuales continuo y no fragmentado de un proceso proporciona oportunidades a los atacantes en el sentido de que los atacantes pueden predecir la ubicación de las instrucciones de máquina reutilizables (MI) y de las regiones de pila y montón.
	  El ROP se basa en la creación de una pila falsa y en la identificación de los MIs reutilizables ya cargados en la memoria del proceso.
 ![[Pasted image 20241204132404.png]]



MODULOS DE PROTECCION CONTRA EXPLOITS
1. Caracteristicas de los modulos de proteccion contra exploits (EPM)
	1. Numeros equivalentes: un EPM de XDR bloquea tecnicas de explotacion concretas proporcionando numeros equivalente de EPM al numero de tecnicas de explotacion
	2. Perfiles de exploits: Puede crear perfiles de exploits para determianr que grupo de EPM esta activo para que procesos
	3. Vacunas selectivas
	4. EPM es analogo a la vacunacion contra un virus en particular, los procesos y los nucleos se vacunan selectivamente
	5. Proteccion de aplicaciones frente a kernels: El agente inyecta EPM en los procesos, mientras que el agente utiliza controladores de kernel contra las vulnerabilidades del kernel.
	Bloqueo EPM ![[Pasted image 20241204132947.png]]
	LISTA DE MODULOS DE PROTECCION CONTRA EXPLOITS
	- Proteccion APC: evita ataques que cambian el orden de ejecucion de un proceso mediante una llamada a procedimiento asincrono (APC)
	- Proteccion contra fuerza bruta: evita que los ataques de fuerza bruta secuestren el control del flujo del proceso mediante el uso de capas de proteccion del sistema operativo integradas, como ASLR
	- Prevencion de ejecucion de datos (DEP): DEP impide que las areas de memoria designadas que contienen datos se ejecuten como codigo.
	- Seguridad de DLL: impide acceso a metadatos cruciales de DLL desde ubicaciones de desconfianza
	- Explit Kit Fingerprint: Usada en kits de exploits de navegador para identificar informacion como el SO o aplicaciones que se ejecutan en un edp
	- Mitigacion JIT: Evita que un atacante omita las mitigaciones de una memoria del SO mediante motores de compilacion Just in Time (JIT)
	- Proteccion de escalada de privilegios de kernel: Evita que un atacante use el privilegio de otro proceso con mayores privilegios para ejecutar un proceso con permiso del sistema
	- Mitigacion de ROP: Protege contra ROP a las API utilizadas en las cadenas de ROP
	- UASLR: Mejora o implementa por completo ASLR con mayor entropia, robustez y aplicacion estricta.
	
Flujo de prevencion de exploits
	![[Pasted image 20241204134040.png]]
	

PERFILES DE EXPLOITS
- Contienen grupos de config para evitar amenazas que aprovechen vulnerabilidades o fallos en SW
- Controlan que EPM estab habilitados en que procesos y kernels
- XDR No permite la habilitacion de un EPM en particular.
- Agrupan funcionalmente los EPM en secciones por tipo de componente vulnerable en el endpoint

	Vulnerabilidades de endpoints: SO, bibliotecas, mecanismos de carga, aplicaciones conocidas, navegadores, protocolos de navegacion, aplicaciones personalizadas.
	Tablas de secciones de perfil de exploit: ![[Pasted image 20241204135614.png]]

	Aprovechar las secciones de la pagina de perfil
	- Proteccion contra exploits del navegador: opera o iexplore.exe
	- Proteccion de procesos vulnerables conocidos excel.exe, word.exe, cmd.exe
	- Proteccion contra vulnerabilidades del SO spoolsv.exe o svchost.exe
	- Proteccion de vulnerabilidades logicas (Protege de los ataques que aprovechan los mecanismos del SO y carga de DLL)
	- Proteccion contra exploits para procesos adicionales (Protege aplicaciones desarrolladas internamente de los ataques de vulnerabilidades)


TRABAJAR CON PROCESOS PROTEGIDOS
1. DLL inyectadas: Process Explorer Sysinternals Suite obtiene una lista de archivos dll inyectados por cortex XDR
2. Obtener lista de procesos protegidos: Se usa aplicacion Cytool con la opcion de enumeracion para obtener la lista actual de procesos protegidos en endpoint pero no muestra los nombres solo los PID o id del procesos.
3. Controladores del kernel Cortex XDR: Encargado de tareas de bajo nivel: administracion de tablas de politicas, inyecciones, prevenciones, proteccion del servicio y supervision del sistema de archivos.  **driverquery.exe /v /fo csv | ConvertFrom-CSV | Select-object**
4. Desactivacion de EPM: Crear una excepcion de proceso para deshabilitar las EPM seleccionadas en un proceso
   ![[Pasted image 20241204170934.png]]
